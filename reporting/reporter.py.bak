"""
Reporter - Generates threat intelligence reports
"""
import json
import csv
import logging
from datetime import datetime
from pathlib import Path
from config import OUTPUT_DIR

logger = logging.getLogger(__name__)

class ThreatReporter:
    def __init__(self):
        self.output_dir = OUTPUT_DIR
        self.report_dir = OUTPUT_DIR / 'reports'
        self.report_dir.mkdir(exist_ok=True)
    
    def generate_html_report(self, iocs: list, correlations: dict) -> str:
        """Generate HTML report"""
        try:
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            html_content = f"""
<html>
<head>
    <title>Threat Intelligence Report</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; }}
        h1 {{ color: #333; }}
        table {{ border-collapse: collapse; width: 100%; margin: 20px 0; }}
        th, td {{ border: 1px solid #ddd; padding: 12px; text-align: left; }}
        th {{ background-color: #4CAF50; color: white; }}
        .critical {{ color: red; font-weight: bold; }}
        .high {{ color: orange; font-weight: bold; }}
    </style>
</head>
<body>
    <h1>Threat Intelligence Report</h1>
    <p>Generated: {timestamp}</p>
    <p>Total IOCs: {len(iocs)}</p>
    
    <h2>IOC Summary</h2>
    <table>
        <tr>
            <th>IOC Value</th>
            <th>Type</th>
            <th>Source</th>
            <th>Severity</th>
            <th>Frequency</th>
        </tr>
"""
            for ioc in iocs[:20]:  # Show first 20
                severity = correlations.get(ioc['ioc_value'], {}).get('severity', 'UNKNOWN')
                frequency = correlations.get(ioc['ioc_value'], {}).get('frequency', 1)
                severity_class = 'critical' if severity == 'CRITICAL' else 'high' if severity == 'HIGH' else ''
                
                html_content += f"""
        <tr>
            <td>{ioc['ioc_value']}</td>
            <td>{ioc['ioc_type']}</td>
            <td>{ioc['source']}</td>
            <td class="{severity_class}">{severity}</td>
            <td>{frequency}</td>
        </tr>
"""
            
            html_content += """
    </table>
</body>
</html>
"""
            
            output_file = self.report_dir / 'threat_report.html'
            with open(output_file, 'w') as f:
                f.write(html_content)
            
            logger.info(f"Generated HTML report: {output_file}")
            return str(output_file)
        except Exception as e:
            logger.error(f"Error generating HTML report: {e}")
            return ""
    
    def export_csv(self, iocs: list, correlations: dict) -> str:
        """Export IOCs to CSV"""
        try:
            output_file = OUTPUT_DIR / 'datasets' / 'iocs_export.csv'
            output_file.parent.mkdir(exist_ok=True)
            
            with open(output_file, 'w', newline='') as f:
                writer = csv.writer(f)
                writer.writerow(['IOC Value', 'Type', 'Source', 'Severity', 'Frequency', 'Score'])
                
                for ioc in iocs:
                    corr_data = correlations.get(ioc['ioc_value'], {})
                    writer.writerow([
                        ioc['ioc_value'],
                        ioc['ioc_type'],
                        ioc['source'],
                        corr_data.get('severity', 'UNKNOWN'),
                        corr_data.get('frequency', 1),
                        corr_data.get('score', 0)
                    ])
            
            logger.info(f"Exported CSV: {output_file}")
            return str(output_file)
        except Exception as e:
            logger.error(f"Error exporting CSV: {e}")
            return ""
    
    def export_json(self, iocs: list, correlations: dict) -> str:
        """Export IOCs to JSON"""
        try:
            output_file = OUTPUT_DIR / 'datasets' / 'iocs_export.json'
            output_file.parent.mkdir(exist_ok=True)
            
            export_data = {
                'generated': datetime.now().isoformat(),
                'total_iocs': len(iocs),
                'iocs': iocs,
                'correlations': correlations
            }
            
            with open(output_file, 'w') as f:
                json.dump(export_data, f, indent=2)
            
            logger.info(f"Exported JSON: {output_file}")
            return str(output_file)
        except Exception as e:
            logger.error(f"Error exporting JSON: {e}")
            return ""
